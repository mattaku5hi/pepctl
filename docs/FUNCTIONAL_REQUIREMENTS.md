# Функциональные требования к проекту PEPCTL

## 1. Назначение
PEPCTL — демон (userspace) и eBPF-программа (kernelspace), обеспечивающие применение L3/L4 политик к сетевому трафику на выбранном интерфейсе Linux, сбор метрик и предоставление HTTP API для управления политиками и наблюдаемости.

## 2. Термины
- **Политика** — правило с полями `src/dst (ip, port, protocol)` и действием `ALLOW|BLOCK|LOG_ONLY|RATE_LIMIT`.
- **Wildcard** — значение `0.0.0.0` для IP, `0` для порта, `ANY` для протокола.
- **RCU-снимок** — атомарно заменяемая структура таблиц политик для lock-free чтений.
- **MetricsServer** — HTTP сервер, предоставляющий `/metrics`, `/stats`, `/policies`, `/health`, `/reset`.

## 3. Акторы
- **Оператор (Ops)** — запускает демон, настраивает интерфейс/порты, применяет политики, анализирует метрики.
- **Система мониторинга** — Prometheus/Grafana, периодически опрашивает `/metrics`.
- **Тестовый генератор трафика** — скрипты/устройства (например SBC) для генерации сетевых попыток соединений.

## 4. Входные/выходные интерфейсы
### 4.1 Конфигурация
- Источник: JSON-файл конфигурации.
- Основные параметры:
  - `network.interface` — имя интерфейса (например `enx00e099002775`).
  - `server.metrics_port` — порт HTTP сервера (MetricsServer).
  - `log.level`, `log.file` — уровень и файл логов.
  - `policy.capacity`, `policy.policies_file` — ёмкость и путь к файлу политик.
  - `ebpf.program_path`, `ebpf.program_type` — путь к eBPF объекту и тип attach (`xdp`/`tc_*`).

### 4.2 HTTP API (MetricsServer)
- `GET /health` — проверка работоспособности.
- `GET /stats` — агрегированные статистики демона/ebpf/политик.
- `GET /metrics` — Prometheus exposition format.
- `GET /policies` — экспорт политик в JSON.
- `POST /policies` — загрузка политик из JSON тела запроса.
- `DELETE /policies` — удаление политики (по `id` в query-параметре `?id=...` или по `id` в JSON теле запроса).
- `POST /reset` — сброс статистик.

## 5. Функциональные требования (FR)

### FR-01 Запуск демона и инициализация
- **Описание**: Система должна запускать userspace-демон с конфигурацией из JSON файла.
- **Условия**: Указан путь к конфигу и корректный `ebpf.program_path`.
- **Результат**:
  - Инициализируется Logger.
  - Инициализируется PolicyEngine.
  - Инициализируется EbpfManager и выполняется attach на указанный интерфейс.
  - Запускается MetricsServer (если включён).

### FR-02 Загрузка политик из файла при старте
- **Описание**: При наличии `policy.policies_file` система должна загрузить политики при инициализации.
- **Результат**:
  - Политики доступны через `GET /policies`.
  - Выполняется синхронизация политик в eBPF map через EbpfManager.

### FR-03 Управление политиками во время работы
- **Описание**: Система должна позволять добавлять/заменять и удалять политики без перезапуска демона.
- **API**:
  - `POST /policies` принимает JSON массив политик.
  - `DELETE /policies` удаляет политику по идентификатору (`id`).
- **Результат**:
  - Изменения применяются атомарно (через RCU-снимок) для readers.

### FR-04 Семантика сопоставления политик
- **Описание**: Система должна сопоставлять пакет/поток с политикой по `src/dst ip/port/protocol`.
- **Правила**:
  - Сначала выполняется точное сопоставление.
  - При отсутствии — wildcard сопоставление.
  - При отсутствии совпадения — поведение по умолчанию (ALLOW).

### FR-05 Действия политик
- **ALLOW**: пропуск трафика.
- **BLOCK**: блокировка трафика.
- **LOG_ONLY**: пропуск + логирование события.
- **RATE_LIMIT**: ограничение пропускной способности в **байтах/сек**.

### FR-06 Rate limiting
- **Описание**: Для `RATE_LIMIT` система должна ограничивать трафик согласно `rate_limit_bps`.
- **Хранилище состояния**: userspace состояние rate-limit по ключу потока.

### FR-07 Метрики и статистики
- **Описание**: Система должна собирать счётчики обработки пакетов и публиковать их.
- **API**:
  - `GET /stats` — JSON статистика.
  - `GET /metrics` — Prometheus.

### FR-08 Логи
- **Описание**: Система должна писать структурированные логи через DI-инъекцию Logger.
- **Управление**:
  - Уровень логирования задаётся в конфиге (`log.level`).

### FR-09 Плановый cleanup
- **Описание**: Система должна поддерживать периодическую очистку истёкших политик.
- **Результат**: истёкшие политики удаляются и перестают участвовать в сопоставлении.

### FR-10 Обработка сигналов
- **SIGTERM/SIGINT**: корректное завершение.
- **SIGHUP**: инициирование reload конфигурации (часть настроек может требовать рестарта).

### FR-11 Динамические изменения во время работы
- **Описание**: Система должна поддерживать управляемые изменения состояния во время работы через HTTP API.
- **Поддерживается без рестарта**:
  - **Политики**: `POST /policies` (загрузка/замена набора политик), `DELETE /policies` (удаление политики по `id`).
  - **Сброс счётчиков**: `POST /reset` (сброс userspace счётчиков и, при наличии EbpfManager, сброс eBPF статистик).
- **Ограничения текущей реализации**:
  - **Log level**: задаётся в конфиге (`log.level`) и применяется при старте; изменение через HTTP API не реализовано.
  - **Порты/интерфейс/eBPF attach**: параметры вроде `server.metrics_port`, `network.interface`, `ebpf.*` требуют рестарта демона для корректного применения.
  - **SIGHUP**: сигнал инициирует перечитывание JSON конфига; применение новых настроек к уже запущенным компонентам в текущем коде ограничено (может потребоваться рестарт).

## 6. Нефункциональные требования (в пределах фактически реализованного)
- **NFR-01 Производительность**: быстрый read path для политик (RCU-снимки без блокировок на чтение).
- **NFR-02 Наблюдаемость**: метрики в формате Prometheus.
- **NFR-03 Сборка**: поддержка сборки через CMakePresets (Clang + Ninja).

## 7. Тестирование (сценарии эксплуатации)
- **Сценарий SBC**: внешний трафик из подсети `192.168.3.0/24` на интерфейс `enx00e099002775`.
- **Генератор**: `tests/sbc_traffic_forever.sh` (8 попыток соединений: 2 на категорию действий).
- **Политики**: `policies/sbc_work.json` (ALLOW/LOG_ONLY/BLOCK/RATE_LIMIT) для тестовых портов.
