#!/bin/bash
set -e

# Pre-installation script for pepctl
# This script runs before the package is installed or upgraded

case "$1" in
    install|upgrade)
        # Stop pepctl service if it's running
        if systemctl is-active --quiet pepctl 2>/dev/null; then
            echo "Stopping pepctl service..."
            systemctl stop pepctl || true
        fi
        
        # Disable pepctl service if it's enabled (will be re-enabled in postinst)
        if systemctl is-enabled --quiet pepctl 2>/dev/null; then
            echo "Disabling pepctl service temporarily..."
            systemctl disable pepctl || true
        fi
        
        # Clean up any existing eBPF programs and maps
        echo "Cleaning up existing eBPF resources..."
        
        # Remove XDP programs from common interfaces
        for iface in $(ip link show | grep -E '^[0-9]+:' | awk -F': ' '{print $2}' | sed 's/@.*//'); do
            if ip link show "$iface" 2>/dev/null | grep -q "prog/xdp"; then
                echo "Removing XDP program from interface $iface"
                ip link set dev "$iface" xdp off 2>/dev/null || true
            fi
        done
        
        # Remove TC programs from common interfaces
        for iface in $(ip link show | grep -E '^[0-9]+:' | awk -F': ' '{print $2}' | sed 's/@.*//'); do
            if tc qdisc show dev "$iface" 2>/dev/null | grep -q clsact; then
                echo "Removing TC qdisc from interface $iface"
                tc qdisc del dev "$iface" clsact 2>/dev/null || true
            fi
        done
        
        # Remove pinned BPF maps
        echo "Removing pinned BPF maps..."
        rm -f /sys/fs/bpf/stats_map 2>/dev/null || true
        rm -f /sys/fs/bpf/policy_map 2>/dev/null || true
        rm -f /sys/fs/bpf/packet_events 2>/dev/null || true
        rm -rf /sys/fs/bpf/xdp/ 2>/dev/null || true
        rm -rf /sys/fs/bpf/tc/ 2>/dev/null || true
        
        # Clean up any pepctl-related BPF maps
        find /sys/fs/bpf/ -name "*pepctl*" -type f -delete 2>/dev/null || true
        
        echo "eBPF cleanup completed"
        ;;
        
    abort-upgrade)
        # Nothing to do
        ;;
        
    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0 